<!DOCTYPE html>
<html>
    <head>
        <title>My DC Example</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF8">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/dc@4.2.7/dist/style/dc.css" rel="stylesheet">
        <style>
            pre#data {
                display: none;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js" type="text/javascript"></script>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dc@4.2.7/dist/dc.min.js"></script>
            </head>
    <body>
        <h1>My DC Example</h1>
        <p>This is a DC example.</p>
        <table>
            <tr>
                <td><div id="chart-ring-year"></div></td>
                <td><div id="chart-line-hitsperday"></div></td>
            </tr>

        </table>


        <div style='clear:both;'>
            <table id="dc-data-table">
                <thead>
                <tr class="header">
                    <th>Day</th>
                    <th>TPS 200</th>
                    <th>TPS 302</th>
                    <th>TPS Total</th>
                </tr>
                </thead>
            </table>
        </div>

        <script>
            function print_filter(filter) {
                var f=eval(filter);
                if (typeof(f.length) != "undefined") {}else{}
                if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
                if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
                console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
            }

            var data = [
                {date: "12/27/2012", http_404: 2, http_200: 190, http_302: 100},
                {date: "12/28/2012", http_404: 2, http_200: 10, http_302: 100},
                {date: "12/29/2012", http_404: 1, http_200: 300, http_302: 200},
                {date: "12/30/2012", http_404: 2, http_200: 90, http_302: 0},
                {date: "12/31/2012", http_404: 2, http_200: 90, http_302: 0},
                {date: "01/01/2013", http_404: 2, http_200: 90, http_302: 0},
                {date: "01/02/2013", http_404: 1, http_200: 10, http_302: 1},
                {date: "01/03/2013", http_404: 2, http_200: 90, http_302: 0},
                {date: "01/04/2013", http_404: 2, http_200: 90, http_302: 0},
                {date: "01/05/2013", http_404: 2, http_200: 90, http_302: 0},
                {date: "01/06/2013", http_404: 2, http_200: 200, http_302: 1},
                {date: "01/07/2013", http_404: 1, http_200: 200, http_302: 100}
            ];

            var ndx = crossfilter(data);
            var parseDate = d3.timeParse("%m/%d/%Y");
            data.forEach(function(d) {
                d.date = parseDate(d.date);
                d.total= d.http_404+d.http_200+d.http_302;
                d.Year=d.date.getFullYear();
            });
            print_filter("data");
            var yearDim  = ndx.dimension(function(d) {return +d.Year;});
            var year_total = yearDim.group().reduceSum(function(d) {return d.total;});
            var dateDim = ndx.dimension(function(d) {return d.date;});
            var hits = dateDim.group().reduceSum(dc.pluck('total'));
            var minDate = dateDim.bottom(1)[0].date;
            var maxDate = dateDim.top(1)[0].date;
            var status_200=dateDim.group().reduceSum(function(d) {return d.http_200;});
            var status_302=dateDim.group().reduceSum(function(d) {return d.http_302;});
            var status_404=dateDim.group().reduceSum(function(d) {return d.http_404;});

            var hitslineChart  = dc.lineChart("#chart-line-hitsperday");
            hitslineChart
                .width(500).height(200)
                .dimension(dateDim)
                .group(status_200,"200")
                .stack(status_302,"302")
                .stack(status_404,"404")
                .renderArea(true)
                .x(d3.scaleTime().domain([minDate, maxDate]))
                .brushOn(false)
                .legend(dc.legend().x(50).y(10).itemHeight(13).gap(5))
                .yAxisLabel("Hits per day");

            var yearRingChart   = dc.pieChart("#chart-ring-year");
            yearRingChart
                .width(150).height(150)
                .dimension(yearDim)
                .group(year_total)
                .innerRadius(30);

            var datatable   = dc.dataTable("#dc-data-table");
            datatable
                .dimension(dateDim)
                .group(function(d) {return d.Year;})
                // dynamic columns creation using an array of closures
                .columns([
                    function(d) { return "<i>"+(d.date.getMonth() + 1) + "/" + d.date.getDate() + "/" +  d.date.getFullYear() + "</i>"; },
                    function(d) {return d.http_200;},
                    function(d) {return d.http_302;},
                    function(d) {return d.http_404;},
                    function(d) {return d.total;}
                ]);
            dc.renderAll();


            // var totalDim = ndx.dimension(function(d) { return d.total; });
            // var total_90 = totalDim.filterExact(90);
            // print_filter("total_90");

            // var total_90_101= totalDim.filter([90,101]);
            // print_filter("total_90_101");
            // var total_3= totalDim.filter(function(d) { if (d%3===0) {return d;} } );
            // print_filter("total_3");
            // totalDim.filterAll();
            // var typeDim  = ndx.dimension(function(d) {return d.type;});
            // typeDim.filterAll()
            // var visa_filter = typeDim.filter("visa");
            // print_filter("visa_filter");
            // var cash_filter = typeDim.filter("cash");
            // print_filter("cash_filter");
            // var total = typeDim.group().reduceSum(function(d) {return d.total;});
            // print_filter("total");
            // var cash_total = ndx.groupAll().reduceSum(function(d) {return d.total;}).value();
            // console.log("cash_total="+cash_total);
            // var cash_and_visa_filter = typeDim.filter(function(d) { if (d ==="visa" || d==="cash") {return d;} });
            // print_filter("cash_and_visa_filter");
        </script>
    </body>
</html>